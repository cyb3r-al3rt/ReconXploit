#!/bin/bash
# ReconXploit v3.0 Professional Edition - Global Launcher
# Makes ReconXploit accessible from anywhere in the system

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Global installation paths
INSTALL_DIR="/opt/reconxploit"
GLOBAL_EXEC="/usr/local/bin/reconxploit"
CURRENT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if running as root for global installation
if [[ $EUID -eq 0 ]]; then
    echo -e "${CYAN}[GLOBAL INSTALL]${NC} Installing ReconXploit v3.0 Professional Edition globally..."

    # Create installation directory
    mkdir -p "$INSTALL_DIR"

    # Copy all files to global location
    echo -e "${BLUE}[INFO]${NC} Copying files to $INSTALL_DIR..."
    cp -r "$CURRENT_DIR"/* "$INSTALL_DIR/"

    # Set proper permissions
    chmod -R 755 "$INSTALL_DIR"
    chmod +x "$INSTALL_DIR/reconxploit"
    chmod +x "$INSTALL_DIR/setup.sh"

    # Create global executable
    cat > "$GLOBAL_EXEC" << 'EOF'
#!/bin/bash
# ReconXploit v3.0 Professional - Global Wrapper

INSTALL_DIR="/opt/reconxploit"
cd "$INSTALL_DIR"

if [[ ! -f "venv/bin/activate" ]]; then
    echo -e "\033[0;31m[ERROR]\033[0m Virtual environment not found!"
    echo -e "\033[0;33m[SOLUTION]\033[0m Run setup first: sudo $INSTALL_DIR/setup.sh"
    exit 1
fi

# Activate virtual environment and run ReconXploit
source venv/bin/activate
export PATH="$PATH:$HOME/go/bin:$HOME/.cargo/bin:$HOME/.local/bin"
export PYTHONPATH="$INSTALL_DIR:$PYTHONPATH"
exec python3 core/reconxploit.py "$@"
EOF

    chmod +x "$GLOBAL_EXEC"

    # Add to system PATH if not already there
    if ! grep -q "/usr/local/bin" /etc/environment; then
        echo 'PATH="/usr/local/bin:$PATH"' >> /etc/environment
    fi

    echo -e "${GREEN}[SUCCESS]${NC} ReconXploit v3.0 Professional installed globally!"
    echo -e "${CYAN}[INFO]${NC} Installation directory: $INSTALL_DIR"
    echo -e "${CYAN}[INFO]${NC} Global command: reconxploit"
    echo ""
    echo -e "${YELLOW}[NEXT STEPS]${NC}"
    echo -e "${BLUE}1.${NC} Run setup: ${YELLOW}cd $INSTALL_DIR && sudo ./setup.sh${NC}"
    echo -e "${BLUE}2.${NC} Test installation: ${YELLOW}reconxploit --check-tools${NC}"
    echo -e "${BLUE}3.${NC} Start reconnaissance: ${YELLOW}reconxploit -d example.com${NC}"
    echo ""

    # Run setup automatically if requested
    read -p "Run setup automatically now? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cd "$INSTALL_DIR"
        ./setup.sh
    fi

    exit 0
fi

# If not running as root, check if globally installed
if [[ -f "$GLOBAL_EXEC" ]]; then
    echo -e "${GREEN}[GLOBAL]${NC} ReconXploit is globally installed"
    echo -e "${CYAN}[INFO]${NC} Use 'reconxploit' command from anywhere"
    exec "$GLOBAL_EXEC" "$@"
fi

# Otherwise, run locally
echo -e "${CYAN}[LOCAL]${NC} Running ReconXploit v3.0 Professional Edition locally"
echo -e "${BLUE}[INFO]${NC} Starting from: $CURRENT_DIR"

# Check for virtual environment
if [[ ! -f "venv/bin/activate" ]]; then
    echo -e "${RED}[ERROR]${NC} Python virtual environment not found!"
    echo -e "${YELLOW}[SOLUTION]${NC} Run the setup script first:"
    echo -e "${CYAN}  chmod +x setup.sh && ./setup.sh${NC}"
    echo ""
    echo -e "${YELLOW}[GLOBAL INSTALL]${NC} To install globally:"
    echo -e "${CYAN}  sudo ./reconxploit${NC}"
    exit 1
fi

# Activate virtual environment
echo -e "${BLUE}[INFO]${NC} Activating Python virtual environment..."
source venv/bin/activate

if [[ $? -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} Failed to activate virtual environment!"
    exit 1
fi

echo -e "${GREEN}[SUCCESS]${NC} Virtual environment activated: $CURRENT_DIR/venv"

# Set up environment variables
export PATH="$PATH:$HOME/go/bin:$HOME/.cargo/bin:$HOME/.local/bin"
export PYTHONPATH="$CURRENT_DIR:$PYTHONPATH"

# Check if core module exists
if [[ ! -f "core/reconxploit.py" ]]; then
    echo -e "${RED}[ERROR]${NC} ReconXploit core module not found!"
    echo -e "${YELLOW}[SOLUTION]${NC} Ensure you extracted the complete package"
    exit 1
fi

# Launch ReconXploit
echo -e "${GREEN}[SUCCESS]${NC} Launching ReconXploit v3.0 Professional Edition..."
echo -e "${CYAN}[PROFESSIONAL]${NC} Advanced reconnaissance with professional-grade analysis!"

exec python3 core/reconxploit.py "$@"
