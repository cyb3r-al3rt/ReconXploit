#!/bin/bash
# ReconXploit v3.0 - Fixed Local Launcher
# Product of Kernelpanic under infosbios.tech

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

print_info "ReconXploit Local Launcher - Starting from: $SCRIPT_DIR"

# Check if virtual environment exists
if [[ ! -f "venv/bin/activate" ]]; then
    print_error "Python virtual environment not found!"
    print_warning "Expected location: $SCRIPT_DIR/venv/bin/activate"
    echo ""
    echo "To fix this issue, run:"
    echo "  cd $SCRIPT_DIR"
    echo "  python3 -m venv venv"
    echo "  source venv/bin/activate"
    echo "  pip install -r requirements.txt"
    exit 1
fi

# Activate virtual environment
print_info "Activating Python virtual environment..."
source venv/bin/activate

# Verify Python environment
if [[ -z "$VIRTUAL_ENV" ]]; then
    print_error "Failed to activate virtual environment"
    exit 1
fi

print_success "Virtual environment activated: $VIRTUAL_ENV"

# Set up environment variables
export PATH="$PATH:$HOME/go/bin:$HOME/.cargo/bin"
export PYTHONPATH="$SCRIPT_DIR:$PYTHONPATH"
export RECONXPLOIT_HOME="$SCRIPT_DIR"

# Check if core module exists
if [[ ! -f "core/reconxploit.py" ]]; then
    print_error "ReconXploit core module not found!"
    print_warning "Expected location: $SCRIPT_DIR/core/reconxploit.py"
    exit 1
fi

# Check Python dependencies
print_info "Checking Python dependencies..."
if ! python3 -c "import colorama, yaml, requests" 2>/dev/null; then
    print_warning "Some Python dependencies missing. Installing..."
    pip install -r requirements.txt 2>/dev/null || print_warning "requirements.txt not found or failed to install"
fi

# Print environment info for debugging
if [[ "$1" == "--debug" ]]; then
    echo ""
    print_info "Debug Information:"
    echo "  Script Directory: $SCRIPT_DIR"
    echo "  Virtual Environment: $VIRTUAL_ENV"
    echo "  Python Path: $PYTHONPATH"
    echo "  System PATH: $PATH"
    echo "  Python Version: $(python3 --version 2>/dev/null || echo 'Not found')"
    echo "  Go Version: $(go version 2>/dev/null || echo 'Not found')"
    echo ""
fi

# Run ReconXploit
print_success "Launching ReconXploit v3.0..."
exec python3 core/reconxploit.py "$@"
